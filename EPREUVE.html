<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créateur de Fiches d'Évaluation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
            --light-color: #f9f9f9;
            --border-color: #ddd;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: cover;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .institution-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .institution-item {
            flex: 1;
            min-width: 200px;
            text-align: center;
            padding: 10px;
        }
        
        .institution-item strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #e8f4fd;
        }
        
        h1 {
            color: white;
            margin-bottom: 15px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header-subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            position: relative;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background-color: var(--light-color);
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .tab:hover {
            background-color: #eaeaea;
            transform: translateY(-2px);
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .tab i {
            margin-right: 8px;
            font-size: 1.1em;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-family: inherit;
            font-size: 15px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .exam-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background-color: var(--light-color);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .exercise {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            background-color: var(--light-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .exercise:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .exercise-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .question {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .points {
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }
        
        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-info {
            background-color: #17a2b8;
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .preview {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-top: 25px;
        }
        
        .preview-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
        }
        
        .preview-title {
            color: var(--secondary-color);
            font-size: 2em;
            margin-bottom: 15px;
        }
        
        .preview-exam-info {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .preview-exam-info div {
            background: white;
            padding: 8px 15px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex: 1;
            min-width: 180px;
            text-align: center;
        }
        
        .preview-section {
            margin-bottom: 30px;
        }
        
        .preview-exercise {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px dashed var(--border-color);
        }
        
        .hidden {
            display: none;
        }
        
        .answer-space {
            height: 20px;
            border-bottom: 2px solid #666;
            margin: 12px 0;
            background: repeating-linear-gradient(90deg, transparent, transparent 5px, #f0f0f0 5px, #f0f0f0 10px);
        }
        
        .choices, .true-false {
            margin-left: 20px;
        }
        
        .matching {
            display: flex;
            flex-direction: column;
        }
        
        .match-item {
            display: flex;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .match-left, .match-right {
            width: 45%;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .match-arrow {
            width: 10%;
            text-align: center;
            font-size: 1.1em;
            color: var(--primary-color);
        }
        
        .correction {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 12px;
            border-left: 4px solid var(--primary-color);
        }
        
        .correction h4 {
            margin-top: 0;
            color: var(--secondary-color);
        }
        
        .editor-container {
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .ql-editor {
            min-height: 150px;
            font-size: 15px;
        }
        
        .saved-exams {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .exam-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary-color);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .exam-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        }
        
        .exam-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        
        .exam-card h3 {
            margin-bottom: 12px;
            color: var(--secondary-color);
            font-size: 1.2em;
        }
        
        .exam-card p {
            margin-bottom: 6px;
            color: #666;
        }
        
        .exam-card-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .latex-output {
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 2px solid #34495e;
            border-radius: 8px;
            padding: 18px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
            line-height: 1.5;
            font-size: 13px;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 18px;
            background-color: var(--light-color);
            border-radius: 8px;
        }
        
        .filter-controls input, .filter-controls select {
            flex: 1;
            min-width: 200px;
        }
        
        footer {
            text-align: center;
            margin-top: 35px;
            font-size: 0.9em;
            color: #7f8c8d;
            padding: 18px;
            border-top: 1px solid var(--border-color);
        }
        
        .empty-state {
            text-align: center;
            padding: 35px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 2.5em;
            margin-bottom: 12px;
            color: #bdc3c7;
        }
        
        .manual-correction {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 2px dashed var(--primary-color);
        }
        
        .manual-correction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .manual-correction-title {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .manual-correction-content {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }
        
        .correction-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid var(--success-color);
        }
        
        .correction-section-title {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .preview {
                box-shadow: none;
                padding: 0;
            }
            
            body {
                background-color: white;
                padding: 0;
            }
            
            .preview-header {
                background: none;
            }
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .exam-info, .preview-exam-info {
                grid-template-columns: 1fr;
            }
            
            .institution-info {
                flex-direction: column;
                text-align: center;
            }
            
            .institution-item {
                min-width: 100%;
                margin-bottom: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="institution-info">
                    <div class="institution-item">
                        <strong>Établissement</strong>
                        <span id="institution-name">Lycée Louis Pasteur</span>
                    </div>
                    <div class="institution-item">
                        <strong>Enseignant</strong>
                        <span id="teacher-name">KOLA Maniwah Essohouna</span>
                    </div>
                    <div class="institution-item">
                        <strong>Matière</strong>
                        <span id="subject-name">Mathématiques</span>
                    </div>
                </div>
                
                <h1><i class="fas fa-file-alt"></i> Créateur de Fiches d'Évaluation</h1>
                <p class="header-subtitle">Application permettant aux enseignants de créer des évaluations, devoirs et travaux dirigés avec différents types de questions</p>
            </div>
        </header>
        
        <div class="tabs no-print">
            <div class="tab active" data-tab="creation-form">
                <i class="fas fa-edit"></i> Création d'Évaluation
            </div>
            <div class="tab" data-tab="correction-form">
                <i class="fas fa-check-circle"></i> Correction
            </div>
            <div class="tab" data-tab="saved-evaluations">
                <i class="fas fa-archive"></i> Évaluations Sauvegardées
            </div>
            <div class="tab" data-tab="preview">
                <i class="fas fa-eye"></i> Aperçu
            </div>
            <div class="tab" data-tab="latex-export">
                <i class="fas fa-code"></i> Export LaTeX
            </div>
        </div>
        
        <!-- Formulaire pour créer l'évaluation -->
        <div id="creation-form" class="tab-content active">
            <h2><i class="fas fa-edit"></i> Création d'Évaluation</h2>
            
            <div class="form-group">
                <h3>Informations générales</h3>
                <div class="exam-info">
                    <div>
                        <label for="evaluation-title"><i class="fas fa-heading"></i> Titre de l'évaluation</label>
                        <input type="text" id="evaluation-title" placeholder="Ex: Devoir sur les fonctions" value="Devoir sur les fonctions">
                    </div>
                    <div>
                        <label for="subject"><i class="fas fa-book"></i> Matière</label>
                        <input type="text" id="subject" placeholder="Ex: Mathématiques" value="Mathématiques">
                    </div>
                    <div>
                        <label for="class-name"><i class="fas fa-users"></i> Classe/Niveau</label>
                        <input type="text" id="class-name" placeholder="Ex: Seconde 7" value="Seconde 7">
                    </div>
                    <div>
                        <label for="evaluation-duration"><i class="fas fa-clock"></i> Durée</label>
                        <input type="text" id="evaluation-duration" placeholder="Ex: 2 heures" value="2 heures">
                    </div>
                    <div>
                        <label for="total-points"><i class="fas fa-star"></i> Total des points</label>
                        <input type="number" id="total-points" placeholder="Ex: 20" value="20">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <h3>Paramètres institutionnels</h3>
                <div class="exam-info">
                    <div>
                        <label for="school-name"><i class="fas fa-school"></i> Établissement</label>
                        <input type="text" id="school-name" placeholder="Nom de l'établissement" value="Lycée Louis Pasteur">
                    </div>
                    <div>
                        <label for="teacher-name-input"><i class="fas fa-user-tie"></i> Enseignant</label>
                        <input type="text" id="teacher-name-input" placeholder="Nom de l'enseignant" value="KOLA Maniwah Essohouna">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <h3>Exercices</h3>
                <div id="exercises-container">
                    <!-- Les exercices seront ajoutés ici dynamiquement -->
                </div>
                <button type="button" id="add-exercise" class="btn"><i class="fas fa-plus"></i> Ajouter un exercice</button>
            </div>
            
            <div class="actions">
                <div class="action-buttons">
                    <button type="button" id="save-evaluation" class="btn btn-success"><i class="fas fa-save"></i> Enregistrer l'évaluation</button>
                    <button type="button" id="preview-evaluation" class="btn"><i class="fas fa-eye"></i> Aperçu</button>
                    <button type="button" id="generate-pdf" class="btn btn-warning"><i class="fas fa-file-pdf"></i> Générer PDF</button>
                    <button type="button" id="reset-evaluation" class="btn btn-danger"><i class="fas fa-trash"></i> Tout effacer</button>
                </div>
            </div>
        </div>
        
        <!-- Formulaire pour créer la correction -->
        <div id="correction-form" class="tab-content">
            <h2><i class="fas fa-check-circle"></i> Correction de l'Évaluation</h2>
            
            <div class="correction-section">
                <div class="correction-section-title">
                    <i class="fas fa-info-circle"></i> Informations de l'évaluation
                </div>
                <div class="exam-info">
                    <div>
                        <label>Titre</label>
                        <div id="correction-evaluation-title">-</div>
                    </div>
                    <div>
                        <label>Matière</label>
                        <div id="correction-subject">-</div>
                    </div>
                    <div>
                        <label>Classe</label>
                        <div id="correction-class-name">-</div>
                    </div>
                    <div>
                        <label>Durée</label>
                        <div id="correction-evaluation-duration">-</div>
                    </div>
                    <div>
                        <label>Total des points</label>
                        <div id="correction-total-points">-</div>
                    </div>
                </div>
            </div>
            
            <div class="correction-section">
                <div class="correction-section-title">
                    <i class="fas fa-tasks"></i> Corrections des exercices
                </div>
                <div id="corrections-container">
                    <!-- Les corrections seront ajoutées ici dynamiquement -->
                </div>
            </div>
            
            <div class="manual-correction">
                <div class="manual-correction-header">
                    <div class="manual-correction-title">
                        <i class="fas fa-pen-alt"></i> Rédaction manuelle de la solution complète
                    </div>
                </div>
                <div class="manual-correction-content">
                    <div class="form-group">
                        <label>Solution complète de l'évaluation</label>
                        <div id="manual-correction-editor" class="editor-container"></div>
                        <p class="help-text" style="color: #666; font-size: 0.9em; margin-top: 5px;">
                            Utilisez cet éditeur pour rédiger la solution complète de l'évaluation avec explications détaillées, méthodes de résolution, et remarques pédagogiques.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="actions">
                <div class="action-buttons">
                    <button type="button" id="save-correction" class="btn btn-success"><i class="fas fa-save"></i> Enregistrer la correction</button>
                    <button type="button" id="preview-correction" class="btn"><i class="fas fa-eye"></i> Aperçu de la correction</button>
                    <button type="button" id="load-evaluation-for-correction" class="btn"><i class="fas fa-file-import"></i> Charger une évaluation</button>
                    <button type="button" id="sync-evaluation-to-correction" class="btn btn-info"><i class="fas fa-sync-alt"></i> Synchroniser avec l'évaluation</button>
                </div>
            </div>
        </div>
        
        <!-- Évaluations sauvegardées -->
        <div id="saved-evaluations" class="tab-content">
            <h2><i class="fas fa-archive"></i> Évaluations Sauvegardées</h2>
            
            <div class="filter-controls">
                <input type="text" id="search-evaluations" placeholder="Rechercher par matière, titre ou enseignant...">
                <select id="filter-class">
                    <option value="">Toutes les classes</option>
                </select>
                <input type="date" id="filter-date">
            </div>
            
            <div id="saved-evaluations-list" class="saved-exams">
                <!-- Les évaluations sauvegardées seront affichées ici -->
            </div>
        </div>
        
        <!-- Aperçu de l'évaluation -->
        <div id="preview" class="tab-content">
            <div class="preview" id="evaluation-preview">
                <div class="preview-header">
                    <h1 class="preview-title" id="preview-evaluation-title">SUJET D'ÉVALUATION</h1>
                    <div class="preview-exam-info" id="preview-exam-info">
                        <!-- Les informations de l'évaluation seront insérées ici -->
                    </div>
                </div>
                
                <div id="preview-exercises">
                    <!-- Les exercices seront insérés ici -->
                </div>
                
                <footer>
                    <p id="preview-total-points">BARÈME TOTAL : 0 points</p>
                    <p>Bon courage !</p>
                </footer>
            </div>
            
            <div class="preview hidden" id="correction-preview">
                <div class="preview-header">
                    <h1 class="preview-title">CORRIGÉ TYPE</h1>
                    <div class="preview-exam-info" id="preview-correction-info">
                        <!-- Les informations de correction seront insérées ici -->
                    </div>
                </div>
                
                <div id="preview-corrections">
                    <!-- Les corrections seront insérés ici -->
                </div>
                
                <div class="manual-correction" id="preview-manual-correction">
                    <div class="manual-correction-header">
                        <div class="manual-correction-title">
                            <i class="fas fa-pen-alt"></i> Solution complète
                        </div>
                    </div>
                    <div class="manual-correction-content" id="preview-manual-correction-content">
                        <!-- Le contenu de la correction manuelle sera inséré ici -->
                    </div>
                </div>
            </div>
            
            <div class="actions no-print">
                <div class="action-buttons">
                    <button type="button" id="print-evaluation" class="btn"><i class="fas fa-print"></i> Imprimer l'évaluation</button>
                    <button type="button" id="print-correction" class="btn"><i class="fas fa-print"></i> Imprimer la correction</button>
                </div>
            </div>
        </div>
        
        <!-- Export LaTeX -->
        <div id="latex-export" class="tab-content">
            <h2><i class="fas fa-code"></i> Export LaTeX</h2>
            
            <div class="actions">
                <div class="action-buttons">
                    <button type="button" id="generate-latex-evaluation" class="btn"><i class="fas fa-code"></i> Générer LaTeX de l'évaluation</button>
                    <button type="button" id="generate-latex-correction" class="btn"><i class="fas fa-code"></i> Générer LaTeX de la correction</button>
                    <button type="button" id="sync-and-generate-correction" class="btn btn-info"><i class="fas fa-sync-alt"></i> Synchroniser et générer LaTeX corrigé</button>
                    <button type="button" id="copy-latex" class="btn btn-success"><i class="fas fa-copy"></i> Copier le code</button>
                </div>
            </div>
            
            <div class="latex-output" id="latex-output">
                <!-- Le code LaTeX sera affiché ici -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // Données globales
        let evaluationData = {
            id: null,
            title: '',
            subject: '',
            class: '',
            duration: '',
            totalPoints: '',
            school: '',
            teacher: '',
            exercises: [],
            corrections: [],
            manualCorrection: '',
            createdAt: new Date().toISOString()
        };
        
        let savedEvaluations = JSON.parse(localStorage.getItem('savedEvaluations')) || [];
        let editors = [];
        let manualCorrectionEditor = null;
        
        // Types d'exercices
        const exerciseTypes = {
            'instructions': 'Instructions',
            'qcm': 'Questions à choix multiple',
            'truefalse': 'Vrai ou Faux',
            'fillblank': 'Questions à trous',
            'traditional': 'Questions traditionnelles',
            'problem': 'Situation problème'
        };
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Gestion des onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                    
                    if (this.dataset.tab === 'saved-evaluations') {
                        loadSavedEvaluations();
                    } else if (this.dataset.tab === 'correction-form') {
                        updateCorrectionFormInfo();
                    }
                });
            });
            
            // Ajout d'un exercice
            document.getElementById('add-exercise').addEventListener('click', addExercise);
            
            // Enregistrement de l'évaluation
            document.getElementById('save-evaluation').addEventListener('click', saveEvaluation);
            
            // Enregistrement de la correction
            document.getElementById('save-correction').addEventListener('click', saveCorrection);
            
            // Aperçu de l'évaluation
            document.getElementById('preview-evaluation').addEventListener('click', function() {
                saveEvaluation();
                document.querySelector('.tab[data-tab="preview"]').click();
                previewEvaluation();
            });
            
            // Aperçu de la correction
            document.getElementById('preview-correction').addEventListener('click', function() {
                document.querySelector('.tab[data-tab="preview"]').click();
                previewCorrection();
            });
            
            // Génération PDF
            document.getElementById('generate-pdf').addEventListener('click', generatePDF);
            
            // Génération LaTeX
            document.getElementById('generate-latex-evaluation').addEventListener('click', generateLatexEvaluation);
            document.getElementById('generate-latex-correction').addEventListener('click', generateLatexCorrection);
            document.getElementById('sync-and-generate-correction').addEventListener('click', syncAndGenerateLatexCorrection);
            document.getElementById('copy-latex').addEventListener('click', copyLatexToClipboard);
            
            // Synchronisation évaluation -> correction
            document.getElementById('sync-evaluation-to-correction').addEventListener('click', syncEvaluationToCorrection);
            
            // Impression
            document.getElementById('print-evaluation').addEventListener('click', function() {
                window.print();
            });
            
            document.getElementById('print-correction').addEventListener('click', function() {
                document.getElementById('evaluation-preview').classList.add('hidden');
                document.getElementById('correction-preview').classList.remove('hidden');
                window.print();
                document.getElementById('evaluation-preview').classList.remove('hidden');
                document.getElementById('correction-preview').classList.add('hidden');
            });
            
            // Filtres pour les évaluations sauvegardées
            document.getElementById('search-evaluations').addEventListener('input', loadSavedEvaluations);
            document.getElementById('filter-class').addEventListener('change', loadSavedEvaluations);
            document.getElementById('filter-date').addEventListener('change', loadSavedEvaluations);
            
            // Mise à jour de l'en-tête
            document.getElementById('school-name').addEventListener('input', updateHeader);
            document.getElementById('teacher-name-input').addEventListener('input', updateHeader);
            document.getElementById('subject').addEventListener('input', updateHeader);
            
            // Charger une évaluation pour correction
            document.getElementById('load-evaluation-for-correction').addEventListener('click', function() {
                document.querySelector('.tab[data-tab="saved-evaluations"]').click();
            });
            
            // Réinitialiser l'évaluation
            document.getElementById('reset-evaluation').addEventListener('click', function() {
                if (confirm('Êtes-vous sûr de vouloir effacer toute l\'évaluation ?')) {
                    evaluationData = {
                        id: null,
                        title: '',
                        subject: '',
                        class: '',
                        duration: '',
                        totalPoints: '',
                        school: '',
                        teacher: '',
                        exercises: [],
                        corrections: [],
                        manualCorrection: '',
                        createdAt: new Date().toISOString()
                    };
                    
                    document.getElementById('exercises-container').innerHTML = '';
                    editors = [];
                    
                    // Réinitialiser les champs
                    document.getElementById('evaluation-title').value = '';
                    document.getElementById('subject').value = '';
                    document.getElementById('class-name').value = '';
                    document.getElementById('evaluation-duration').value = '';
                    document.getElementById('total-points').value = '';
                    document.getElementById('school-name').value = '';
                    document.getElementById('teacher-name-input').value = '';
                    
                    // Ajouter un exercice par défaut
                    addExercise();
                    
                    alert('Évaluation réinitialisée avec succès!');
                }
            });
            
            // Initialiser l'éditeur de correction manuelle
            manualCorrectionEditor = new Quill('#manual-correction-editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'font': [] }],
                        [{ 'align': [] }],
                        ['clean']
                    ]
                },
                placeholder: 'Rédigez ici la solution complète de l\'évaluation avec toutes les explications nécessaires...'
            });
            
            // Mettre à jour l'en-tête
            updateHeader();
            
            // Ajouter un exercice par défaut
            addExercise();
            
            // Charger les évaluations sauvegardées
            loadSavedEvaluations();
        });
        
        // Fonction pour synchroniser le contenu de l'évaluation avec le formulaire de correction
        function syncEvaluationToCorrection() {
            saveEvaluation(); // S'assurer que l'évaluation est à jour
            
            // Mettre à jour les informations de correction avec les données de l'évaluation
            updateCorrectionFormInfo();
            
            // Reconstruire les formulaires de correction pour correspondre aux exercices de l'évaluation
            document.getElementById('corrections-container').innerHTML = '';
            evaluationData.exercises.forEach(exercise => {
                renderCorrectionForm(exercise.id);
            });
            
            alert('Contenu de l\'évaluation synchronisé avec le formulaire de correction!');
        }
        
        // Fonction pour synchroniser et générer le LaTeX de correction
        function syncAndGenerateLatexCorrection() {
            syncEvaluationToCorrection();
            generateLatexCorrection();
        }
        
        // Fonction pour mettre à jour l'en-tête
        function updateHeader() {
            const schoolName = document.getElementById('school-name').value || 'Lycée Louis Pasteur';
            const teacherName = document.getElementById('teacher-name-input').value || 'KOLA Maniwah Essohouna';
            const subject = document.getElementById('subject').value || 'Mathématiques';
            
            document.getElementById('institution-name').textContent = schoolName;
            document.getElementById('teacher-name').textContent = teacherName;
            document.getElementById('subject-name').textContent = subject;
        }
        
        // Fonction pour mettre à jour les informations dans le formulaire de correction
        function updateCorrectionFormInfo() {
            document.getElementById('correction-evaluation-title').textContent = evaluationData.title || '-';
            document.getElementById('correction-subject').textContent = evaluationData.subject || '-';
            document.getElementById('correction-class-name').textContent = evaluationData.class || '-';
            document.getElementById('correction-evaluation-duration').textContent = evaluationData.duration || '-';
            document.getElementById('correction-total-points').textContent = evaluationData.totalPoints || '-';
            
            // Charger la correction manuelle si elle existe
            if (manualCorrectionEditor && evaluationData.manualCorrection) {
                manualCorrectionEditor.root.innerHTML = evaluationData.manualCorrection;
            }
        }
        
        // Fonction pour ajouter un exercice
        function addExercise() {
            const exerciseId = evaluationData.exercises.length;
            evaluationData.exercises.push({
                id: exerciseId,
                title: '',
                type: 'instructions',
                instructions: '',
                questions: []
            });
            
            evaluationData.corrections.push({
                exerciseId: exerciseId,
                answers: []
            });
            
            renderExerciseForm(exerciseId);
            renderCorrectionForm(exerciseId);
        }
        
        // Fonction pour afficher le formulaire d'un exercice
        function renderExerciseForm(exerciseId) {
            const container = document.getElementById('exercises-container');
            
            const exerciseDiv = document.createElement('div');
            exerciseDiv.className = 'exercise';
            exerciseDiv.id = `exercise-${exerciseId}`;
            
            exerciseDiv.innerHTML = `
                <div class="exercise-header">
                    <div class="exercise-title">Exercice ${romanize(exerciseId + 1)}</div>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeExercise(${exerciseId})"><i class="fas fa-trash"></i> Supprimer</button>
                </div>
                <div class="form-group">
                    <label for="exercise-title-${exerciseId}">Titre de l'exercice</label>
                    <input type="text" id="exercise-title-${exerciseId}" placeholder="Ex: Situation d'évaluation">
                </div>
                <div class="form-group">
                    <label for="exercise-type-${exerciseId}">Type d'exercice</label>
                    <select id="exercise-type-${exerciseId}">
                        ${Object.entries(exerciseTypes).map(([key, value]) => 
                            `<option value="${key}">${value}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="exercise-instructions-${exerciseId}">Instructions</label>
                    <div id="exercise-instructions-editor-${exerciseId}" class="editor-container"></div>
                </div>
                <div class="form-group">
                    <h4>Questions</h4>
                    <div id="questions-container-${exerciseId}">
                        <!-- Les questions seront ajoutées ici -->
                    </div>
                    <button type="button" class="btn btn-sm" onclick="addQuestion(${exerciseId})"><i class="fas fa-plus"></i> Ajouter une question</button>
                </div>
            `;
            
            container.appendChild(exerciseDiv);
            
            // Initialiser l'éditeur de texte enrichi
            const instructionsEditor = new Quill(`#exercise-instructions-editor-${exerciseId}`, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'font': [] }],
                        [{ 'align': [] }],
                        ['clean']
                    ]
                },
                placeholder: 'Instructions pour cet exercice...'
            });
            
            editors.push({
                type: 'instructions',
                exerciseId: exerciseId,
                editor: instructionsEditor
            });
            
            // Ajouter un événement pour mettre à jour le type d'exercice
            document.getElementById(`exercise-type-${exerciseId}`).addEventListener('change', function() {
                updateExerciseType(exerciseId, this.value);
            });
            
            // Ajouter une question par défaut
            addQuestion(exerciseId);
        }
        
        // Fonction pour afficher le formulaire de correction d'un exercice
        function renderCorrectionForm(exerciseId) {
            const container = document.getElementById('corrections-container');
            
            const correctionDiv = document.createElement('div');
            correctionDiv.className = 'exercise';
            correctionDiv.id = `correction-${exerciseId}`;
            
            correctionDiv.innerHTML = `
                <div class="exercise-header">
                    <div class="exercise-title">Correction - Exercice ${romanize(exerciseId + 1)}</div>
                </div>
                <div class="form-group">
                    <div id="correction-questions-${exerciseId}">
                        <!-- Les corrections de questions seront ajoutées ici -->
                    </div>
                </div>
            `;
            
            container.appendChild(correctionDiv);
            
            // Rendre les corrections pour chaque question existante
            if (evaluationData.exercises[exerciseId]) {
                evaluationData.exercises[exerciseId].questions.forEach(question => {
                    renderCorrectionQuestion(exerciseId, question.id);
                });
            }
        }
        
        // Fonction pour ajouter une question à un exercice
        function addQuestion(exerciseId) {
            if (!evaluationData.exercises[exerciseId]) return;
            
            const questionId = evaluationData.exercises[exerciseId].questions.length;
            evaluationData.exercises[exerciseId].questions.push({
                id: questionId,
                text: '',
                points: 1
            });
            
            if (evaluationData.corrections[exerciseId]) {
                evaluationData.corrections[exerciseId].answers.push('');
            }
            
            renderQuestionForm(exerciseId, questionId);
            renderCorrectionQuestion(exerciseId, questionId);
        }
        
        // Fonction pour afficher le formulaire d'une question
        function renderQuestionForm(exerciseId, questionId) {
            const container = document.getElementById(`questions-container-${exerciseId}`);
            if (!container) return;
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question';
            questionDiv.id = `question-${exerciseId}-${questionId}`;
            
            questionDiv.innerHTML = `
                <div class="question-header">
                    <div>Question ${questionId + 1}</div>
                    <div>
                        <label for="question-points-${exerciseId}-${questionId}">Points:</label>
                        <input type="number" id="question-points-${exerciseId}-${questionId}" min="0" step="0.5" value="1" style="width: 70px;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="question-text-${exerciseId}-${questionId}">Texte de la question</label>
                    <div id="question-text-editor-${exerciseId}-${questionId}" class="editor-container"></div>
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeQuestion(${exerciseId}, ${questionId})"><i class="fas fa-trash"></i> Supprimer cette question</button>
            `;
            
            container.appendChild(questionDiv);
            
            // Initialiser l'éditeur de texte enrichi pour la question
            const questionEditor = new Quill(`#question-text-editor-${exerciseId}-${questionId}`, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'font': [] }],
                        [{ 'align': [] }],
                        ['clean']
                    ]
                },
                placeholder: 'Entrez le texte de la question...'
            });
            
            editors.push({
                type: 'question',
                exerciseId: exerciseId,
                questionId: questionId,
                editor: questionEditor
            });
        }
        
        // Fonction pour afficher la correction d'une question
        function renderCorrectionQuestion(exerciseId, questionId) {
            const container = document.getElementById(`correction-questions-${exerciseId}`);
            if (!container) return;
            
            const correctionDiv = document.createElement('div');
            correctionDiv.className = 'question';
            correctionDiv.id = `correction-question-${exerciseId}-${questionId}`;
            
            correctionDiv.innerHTML = `
                <div class="question-header">
                    <div>Correction - Question ${questionId + 1}</div>
                </div>
                <div class="form-group">
                    <label for="correction-answer-${exerciseId}-${questionId}">Réponse</label>
                    <div id="correction-answer-editor-${exerciseId}-${questionId}" class="editor-container"></div>
                </div>
            `;
            
            container.appendChild(correctionDiv);
            
            // Initialiser l'éditeur de texte enrichi pour la correction
            const correctionEditor = new Quill(`#correction-answer-editor-${exerciseId}-${questionId}`, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'font': [] }],
                        [{ 'align': [] }],
                        ['clean']
                    ]
                },
                placeholder: 'Entrez la réponse correcte...'
            });
            
            editors.push({
                type: 'correction',
                exerciseId: exerciseId,
                questionId: questionId,
                editor: correctionEditor
            });
        }
        
        // Fonction pour supprimer un exercice
        function removeExercise(exerciseId) {
            if (evaluationData.exercises.length > 1) {
                evaluationData.exercises.splice(exerciseId, 1);
                evaluationData.corrections.splice(exerciseId, 1);
                
                // Réorganiser les IDs
                evaluationData.exercises.forEach((ex, idx) => ex.id = idx);
                evaluationData.corrections.forEach((cor, idx) => cor.exerciseId = idx);
                
                // Re-rendre tous les formulaires
                renderAllForms();
            } else {
                alert('Vous devez avoir au moins un exercice.');
            }
        }
        
        // Fonction pour supprimer une question
        function removeQuestion(exerciseId, questionId) {
            const exercise = evaluationData.exercises[exerciseId];
            if (exercise && exercise.questions.length > 1) {
                exercise.questions.splice(questionId, 1);
                if (evaluationData.corrections[exerciseId]) {
                    evaluationData.corrections[exerciseId].answers.splice(questionId, 1);
                }
                
                // Réorganiser les IDs
                exercise.questions.forEach((q, idx) => q.id = idx);
                
                // Re-rendre l'exercice
                renderExerciseForm(exerciseId);
                renderCorrectionForm(exerciseId);
            } else {
                alert('Vous devez avoir au moins une question par exercice.');
            }
        }
        
        // Fonction pour re-rendre tous les formulaires
        function renderAllForms() {
            document.getElementById('exercises-container').innerHTML = '';
            document.getElementById('corrections-container').innerHTML = '';
            editors = [];
            
            evaluationData.exercises.forEach(exercise => {
                renderExerciseForm(exercise.id);
                renderCorrectionForm(exercise.id);
            });
        }
        
        // Fonction pour mettre à jour le type d'exercice
        function updateExerciseType(exerciseId, type) {
            // Cette fonction pourrait adapter l'interface en fonction du type d'exercice
            console.log(`Exercice ${exerciseId} changé en type: ${type}`);
        }
        
        // Fonction pour enregistrer les données de l'évaluation
        function saveEvaluation() {
            // Enregistrer les informations générales
            evaluationData.title = document.getElementById('evaluation-title').value;
            evaluationData.subject = document.getElementById('subject').value;
            evaluationData.class = document.getElementById('class-name').value;
            evaluationData.duration = document.getElementById('evaluation-duration').value;
            evaluationData.totalPoints = document.getElementById('total-points').value;
            
            // Enregistrer les informations institutionnelles
            evaluationData.school = document.getElementById('school-name').value;
            evaluationData.teacher = document.getElementById('teacher-name-input').value;
            
            // Enregistrer les exercices et questions
            evaluationData.exercises.forEach(exercise => {
                exercise.title = document.getElementById(`exercise-title-${exercise.id}`).value;
                exercise.type = document.getElementById(`exercise-type-${exercise.id}`).value;
                
                // Récupérer le contenu de l'éditeur d'instructions
                const instructionsEditor = editors.find(e => 
                    e.type === 'instructions' && e.exerciseId === exercise.id
                );
                if (instructionsEditor) {
                    exercise.instructions = instructionsEditor.editor.root.innerHTML;
                }
                
                exercise.questions.forEach(question => {
                    // Récupérer le contenu de l'éditeur de question
                    const questionEditor = editors.find(e => 
                        e.type === 'question' && e.exerciseId === exercise.id && e.questionId === question.id
                    );
                    if (questionEditor) {
                        question.text = questionEditor.editor.root.innerHTML;
                    }
                    
                    const pointsInput = document.getElementById(`question-points-${exercise.id}-${question.id}`);
                    if (pointsInput) {
                        question.points = parseFloat(pointsInput.value) || 1;
                    }
                });
            });
            
            // Générer un ID si nécessaire
            if (!evaluationData.id) {
                evaluationData.id = 'eval_' + new Date().getTime();
            }
            
            // Mettre à jour l'en-tête
            updateHeader();
            
            alert('Évaluation enregistrée avec succès!');
        }
        
        // Fonction pour enregistrer les corrections
        function saveCorrection() {
            saveEvaluation(); // S'assurer que l'évaluation est à jour
            
            // Enregistrer les corrections
            evaluationData.corrections.forEach(correction => {
                correction.answers = [];
                const exercise = evaluationData.exercises[correction.exerciseId];
                if (exercise) {
                    exercise.questions.forEach(question => {
                        // Récupérer le contenu de l'éditeur de correction
                        const correctionEditor = editors.find(e => 
                            e.type === 'correction' && e.exerciseId === correction.exerciseId && e.questionId === question.id
                        );
                        if (correctionEditor) {
                            correction.answers.push(correctionEditor.editor.root.innerHTML);
                        } else {
                            correction.answers.push('');
                        }
                    });
                }
            });
            
            // Enregistrer la correction manuelle
            if (manualCorrectionEditor) {
                evaluationData.manualCorrection = manualCorrectionEditor.root.innerHTML;
            }
            
            // Sauvegarder dans le localStorage
            const existingIndex = savedEvaluations.findIndex(eval => eval.id === evaluationData.id);
            if (existingIndex !== -1) {
                savedEvaluations[existingIndex] = {...evaluationData};
            } else {
                savedEvaluations.push({...evaluationData});
            }
            
            localStorage.setItem('savedEvaluations', JSON.stringify(savedEvaluations));
            
            alert('Correction enregistrée avec succès!');
        }
        
        // Fonction pour afficher l'aperçu de l'évaluation
        function previewEvaluation() {
            const previewInfo = document.getElementById('preview-exam-info');
            previewInfo.innerHTML = `
                <div><strong>Titre :</strong> ${evaluationData.title}</div>
                <div><strong>Matière :</strong> ${evaluationData.subject}</div>
                <div><strong>Classe :</strong> ${evaluationData.class}</div>
                <div><strong>Durée :</strong> ${evaluationData.duration}</div>
                <div><strong>Enseignant :</strong> ${evaluationData.teacher}</div>
                <div><strong>Établissement :</strong> ${evaluationData.school || 'Lycée Louis Pasteur'}</div>
            `;
            
            const previewExercises = document.getElementById('preview-exercises');
            previewExercises.innerHTML = '';
            
            let totalPoints = 0;
            
            evaluationData.exercises.forEach(exercise => {
                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'preview-section';
                
                let exercisePoints = 0;
                let questionsHTML = '';
                
                exercise.questions.forEach(question => {
                    exercisePoints += question.points;
                    
                    questionsHTML += `
                        <div class="question">
                            <div class="question-header">
                                <div><strong>Question :</strong> ${question.text}</div>
                                <div class="points">${question.points} point(s)</div>
                            </div>
                            <div class="answer-space"></div>
                        </div>
                    `;
                });
                
                totalPoints += exercisePoints;
                
                exerciseDiv.innerHTML = `
                    <h2>EXERCICE ${romanize(exercise.id + 1)} - ${exercise.title.toUpperCase()} (${exercisePoints} points)</h2>
                    <div class="preview-exercise">
                        <p><strong>Instructions :</strong> ${exercise.instructions}</p>
                        ${questionsHTML}
                    </div>
                `;
                
                previewExercises.appendChild(exerciseDiv);
            });
            
            document.getElementById('preview-total-points').textContent = `BARÈME TOTAL : ${totalPoints} points`;
            
            // Afficher l'aperçu de l'évaluation
            document.getElementById('evaluation-preview').classList.remove('hidden');
            document.getElementById('correction-preview').classList.add('hidden');
        }
        
        // Fonction pour afficher l'aperçu de la correction
        function previewCorrection() {
            const previewInfo = document.getElementById('preview-correction-info');
            previewInfo.innerHTML = `
                <div><strong>Titre :</strong> ${evaluationData.title}</div>
                <div><strong>Matière :</strong> ${evaluationData.subject}</div>
                <div><strong>Classe :</strong> ${evaluationData.class}</div>
                <div><strong>Durée :</strong> ${evaluationData.duration}</div>
                <div><strong>Enseignant :</strong> ${evaluationData.teacher}</div>
                <div><strong>Établissement :</strong> ${evaluationData.school || 'Lycée Louis Pasteur'}</div>
            `;
            
            const previewCorrections = document.getElementById('preview-corrections');
            previewCorrections.innerHTML = '';
            
            evaluationData.exercises.forEach(exercise => {
                const correction = evaluationData.corrections.find(c => c.exerciseId === exercise.id);
                if (!correction) return;
                
                const correctionDiv = document.createElement('div');
                correctionDiv.className = 'preview-section';
                
                let answersHTML = '';
                
                exercise.questions.forEach((question, index) => {
                    answersHTML += `
                        <div class="question">
                            <div class="question-header">
                                <div><strong>Question ${index + 1} :</strong> ${question.text}</div>
                                <div class="points">${question.points} point(s)</div>
                            </div>
                            <div class="correction">
                                <p><strong>Réponse :</strong> ${correction.answers[index] || 'Non spécifiée'}</p>
                            </div>
                        </div>
                    `;
                });
                
                correctionDiv.innerHTML = `
                    <h2>CORRECTION - EXERCICE ${romanize(exercise.id + 1)}</h2>
                    <div class="preview-exercise">
                        ${answersHTML}
                    </div>
                `;
                
                previewCorrections.appendChild(correctionDiv);
            });
            
            // Afficher la correction manuelle
            const manualCorrectionPreview = document.getElementById('preview-manual-correction-content');
            if (evaluationData.manualCorrection) {
                manualCorrectionPreview.innerHTML = evaluationData.manualCorrection;
                document.getElementById('preview-manual-correction').classList.remove('hidden');
            } else {
                document.getElementById('preview-manual-correction').classList.add('hidden');
            }
            
            // Afficher l'aperçu de la correction
            document.getElementById('evaluation-preview').classList.add('hidden');
            document.getElementById('correction-preview').classList.remove('hidden');
        }
        
        // Fonction pour charger les évaluations sauvegardées
        function loadSavedEvaluations() {
            const searchTerm = document.getElementById('search-evaluations').value.toLowerCase();
            const filterClass = document.getElementById('filter-class').value;
            const filterDate = document.getElementById('filter-date').value;
            
            const filteredEvaluations = savedEvaluations.filter(evaluation => {
                const matchesSearch = !searchTerm || 
                    evaluation.subject.toLowerCase().includes(searchTerm) ||
                    evaluation.title.toLowerCase().includes(searchTerm) ||
                    evaluation.teacher.toLowerCase().includes(searchTerm);
                
                const matchesClass = !filterClass || evaluation.class === filterClass;
                
                const matchesDate = !filterDate || evaluation.createdAt.split('T')[0] === filterDate;
                
                return matchesSearch && matchesClass && matchesDate;
            });
            
            const container = document.getElementById('saved-evaluations-list');
            
            if (filteredEvaluations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>Aucune évaluation trouvée</h3>
                        <p>Aucune évaluation sauvegardée ne correspond aux critères de recherche.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            // Mettre à jour le filtre de classe
            const classFilter = document.getElementById('filter-class');
            const classes = [...new Set(savedEvaluations.map(e => e.class))];
            classFilter.innerHTML = '<option value="">Toutes les classes</option>';
            classes.forEach(cls => {
                if (cls) {
                    classFilter.innerHTML += `<option value="${cls}">${cls}</option>`;
                }
            });
            
            filteredEvaluations.forEach(evaluation => {
                // Vérifier si l'évaluation a une correction
                const hasCorrection = evaluation.corrections && evaluation.corrections.some(c => 
                    c.answers && c.answers.some(a => a && a.trim() !== '')
                ) || evaluation.manualCorrection;
                
                const evaluationCard = document.createElement('div');
                evaluationCard.className = 'exam-card';
                
                evaluationCard.innerHTML = `
                    <h3>${evaluation.title}</h3>
                    <p><strong>Matière:</strong> ${evaluation.subject}</p>
                    <p><strong>Classe:</strong> ${evaluation.class}</p>
                    <p><strong>Durée:</strong> ${evaluation.duration}</p>
                    <p><strong>Points:</strong> ${evaluation.totalPoints}</p>
                    <p><strong>Enseignant:</strong> ${evaluation.teacher}</p>
                    <p><strong>Statut correction:</strong> ${hasCorrection ? '<span style="color: var(--success-color);">Complète</span>' : '<span style="color: var(--accent-color);">À compléter</span>'}</p>
                    <div class="exam-card-actions">
                        <button type="button" class="btn btn-sm" onclick="loadEvaluation('${evaluation.id}')"><i class="fas fa-edit"></i> Modifier</button>
                        <button type="button" class="btn btn-sm" onclick="loadEvaluationForCorrection('${evaluation.id}')"><i class="fas fa-check-circle"></i> Corriger</button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteEvaluation('${evaluation.id}')"><i class="fas fa-trash"></i> Supprimer</button>
                    </div>
                `;
                
                container.appendChild(evaluationCard);
            });
        }
        
        // Fonction pour charger une évaluation
        function loadEvaluation(evaluationId) {
            const evaluation = savedEvaluations.find(e => e.id === evaluationId);
            if (evaluation) {
                evaluationData = JSON.parse(JSON.stringify(evaluation));
                renderAllForms();
                
                // Remplir les champs institutionnels
                document.getElementById('school-name').value = evaluationData.school || '';
                document.getElementById('teacher-name-input').value = evaluationData.teacher || '';
                
                updateHeader();
                document.querySelector('.tab[data-tab="creation-form"]').click();
                alert('Évaluation chargée avec succès!');
            }
        }
        
        // Fonction pour charger une évaluation pour correction
        function loadEvaluationForCorrection(evaluationId) {
            const evaluation = savedEvaluations.find(e => e.id === evaluationId);
            if (evaluation) {
                evaluationData = JSON.parse(JSON.stringify(evaluation));
                renderAllForms();
                
                // Remplir les champs institutionnels
                document.getElementById('school-name').value = evaluationData.school || '';
                document.getElementById('teacher-name-input').value = evaluationData.teacher || '';
                
                // Mettre à jour l'éditeur de correction manuelle
                if (manualCorrectionEditor && evaluationData.manualCorrection) {
                    manualCorrectionEditor.root.innerHTML = evaluationData.manualCorrection;
                }
                
                updateCorrectionFormInfo();
                document.querySelector('.tab[data-tab="correction-form"]').click();
                alert('Évaluation chargée pour correction!');
            }
        }
        
        // Fonction pour supprimer une évaluation
        function deleteEvaluation(evaluationId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette évaluation ?')) {
                savedEvaluations = savedEvaluations.filter(evaluation => evaluation.id !== evaluationId);
                localStorage.setItem('savedEvaluations', JSON.stringify(savedEvaluations));
                loadSavedEvaluations();
            }
        }
        
        // Fonction pour générer un PDF
        function generatePDF() {
            saveEvaluation();
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Récupérer le contenu de l'aperçu
            const previewElement = document.getElementById('evaluation-preview');
            
            // Créer un clone de l'élément pour l'impression
            const printElement = previewElement.cloneNode(true);
            printElement.style.width = '100%';
            printElement.style.margin = '0';
            printElement.style.padding = '0';
            printElement.style.boxShadow = 'none';
            printElement.style.background = 'white';
            
            // Appliquer des styles pour éviter les coupures
            const sections = printElement.querySelectorAll('.preview-section, .preview-exercise, .question');
            sections.forEach(section => {
                section.style.pageBreakInside = 'avoid';
                section.style.breakInside = 'avoid';
            });
            
            // Ajouter l'élément cloné au corps temporairement
            printElement.style.position = 'fixed';
            printElement.style.left = '0';
            printElement.style.top = '0';
            printElement.style.zIndex = '-1000';
            document.body.appendChild(printElement);
            
            // Générer le PDF
            html2canvas(printElement, {
                scale: 2,
                useCORS: true,
                logging: false,
                width: printElement.scrollWidth,
                height: printElement.scrollHeight
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = doc.internal.pageSize.getWidth();
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Ajouter la première page
                doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                // Supprimer l'élément cloné
                document.body.removeChild(printElement);
                
                // Nom du fichier
                const fileName = `evaluation_${evaluationData.title.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
            }).catch(error => {
                console.error('Erreur lors de la génération du PDF:', error);
                alert('Une erreur est survenue lors de la génération du PDF. Veuillez réessayer.');
                
                // Nettoyer en cas d'erreur
                if (document.body.contains(printElement)) {
                    document.body.removeChild(printElement);
                }
            });
        }
        
        // Fonction pour générer le code LaTeX de l'évaluation
        function generateLatexEvaluation() {
            saveEvaluation();
            
            let latexCode = `\\documentclass[12pt,a4paper]{article}
\\usepackage[utf8]{inputenc}
\\usepackage[T1]{fontenc}
\\usepackage[french]{babel}
\\usepackage{amsmath}
\\usepackage{amsfonts}
\\usepackage{amssymb}
\\usepackage{graphicx}
\\usepackage{enumitem}
\\usepackage{geometry}
\\usepackage{xcolor}
\\usepackage{titlesec}
\\usepackage{fancyhdr}

\\geometry{left=2cm,right=2cm,top=2cm,bottom=2cm}

\\pagestyle{fancy}
\\fancyhf{}
\\fancyhead[L]{\\textbf{${evaluationData.school || 'Établissement'}}}
\\fancyhead[C]{\\textbf{${evaluationData.subject} - ${evaluationData.title}}}
\\fancyhead[R]{\\textbf{${formatDate(evaluationData.createdAt)}}}
\\fancyfoot[C]{\\thepage}

\\titleformat{\\section}{\\Large\\bfseries}{}{0pt}{}

\\title{${evaluationData.subject} - ${evaluationData.title}}
\\author{${evaluationData.teacher}}
\\date{${formatDate(evaluationData.createdAt)}}

\\begin{document}

\\maketitle

\\vspace{1cm}

\\begin{center}
    \\textbf{\\Large SUJET D'ÉVALUATION}
\\end{center}

\\vspace{0.5cm}

\\begin{tabular}{|p{0.25\\textwidth}|p{0.7\\textwidth}|}
    \\hline
    \\textbf{Titre} & ${evaluationData.title} \\\\
    \\hline
    \\textbf{Matière} & ${evaluationData.subject} \\\\
    \\hline
    \\textbf{Classe} & ${evaluationData.class} \\\\
    \\hline
    \\textbf{Durée} & ${evaluationData.duration} \\\\
    \\hline
    \\textbf{Enseignant} & ${evaluationData.teacher} \\\\
    \\hline
    \\textbf{Établissement} & ${evaluationData.school || 'Non spécifié'} \\\\
    \\hline
\\end{tabular}

\\vspace{1cm}

\\noindent\\textbf{Instructions générales:}
\\begin{itemize}
    \\item La clarté des raisonnements et la qualité de la rédaction seront prises en compte.
    \\item Le barème est donné à titre indicatif.
\\end{itemize}

\\vspace{1cm}
`;
            
            let totalPoints = 0;
            
            evaluationData.exercises.forEach(exercise => {
                let exercisePoints = 0;
                exercise.questions.forEach(q => exercisePoints += q.points);
                totalPoints += exercisePoints;
                
                latexCode += `\\section*{Exercice ${romanize(exercise.id + 1)} : ${exercise.title} (${exercisePoints} points)}

${htmlToLatex(exercise.instructions)}

\\begin{enumerate}[label=\\textbf{\\arabic*.}, wide]
`;
                
                exercise.questions.forEach(question => {
                    latexCode += `    \\item[\\hspace{1cm}] ${htmlToLatex(question.text)}
    \\hfill \\textbf{(${question.points} point${question.points > 1 ? 's' : ''})}
    
    \\vspace{1cm}
`;
                });
                
                latexCode += `\\end{enumerate}

\\vspace{0.5cm}
`;
            });
            
            latexCode += `\\vfill

\\begin{center}
    \\framebox[0.9\\textwidth]{\\textbf{Barème total: ${totalPoints} points}}
\\end{center}

\\end{document}`;
            
            document.getElementById('latex-output').textContent = latexCode;
        }
        
        // Fonction pour générer le code LaTeX de la correction
        function generateLatexCorrection() {
            saveCorrection();
            
            let latexCode = `\\documentclass[12pt,a4paper]{article}
\\usepackage[utf8]{inputenc}
\\usepackage[T1]{fontenc}
\\usepackage[french]{babel}
\\usepackage{amsmath}
\\usepackage{amsfonts}
\\usepackage{amssymb}
\\usepackage{graphicx}
\\usepackage{enumitem}
\\usepackage{geometry}
\\usepackage{xcolor}
\\usepackage{titlesec}
\\usepackage{fancyhdr}

\\geometry{left=2cm,right=2cm,top=2cm,bottom=2cm}

\\pagestyle{fancy}
\\fancyhf{}
\\fancyhead[L]{\\textbf{${evaluationData.school || 'Établissement'}}}
\\fancyhead[C]{\\textbf{${evaluationData.subject} - ${evaluationData.title} - CORRIGÉ}}
\\fancyhead[R]{\\textbf{${formatDate(evaluationData.createdAt)}}}
\\fancyfoot[C]{\\thepage}

\\titleformat{\\section}{\\Large\\bfseries}{}{0pt}{}

\\title{${evaluationData.subject} - ${evaluationData.title} - CORRIGÉ}
\\author{${evaluationData.teacher}}
\\date{${formatDate(evaluationData.createdAt)}}

\\begin{document}

\\maketitle

\\vspace{1cm}

\\begin{center}
    \\textbf{\\Large CORRIGÉ TYPE}
\\end{center}

\\vspace{0.5cm}

\\begin{tabular}{|p{0.25\\textwidth}|p{0.7\\textwidth}|}
    \\hline
    \\textbf{Titre} & ${evaluationData.title} \\\\
    \\hline
    \\textbf{Matière} & ${evaluationData.subject} \\\\
    \\hline
    \\textbf{Classe} & ${evaluationData.class} \\\\
    \\hline
    \\textbf{Durée} & ${evaluationData.duration} \\\\
    \\hline
    \\textbf{Enseignant} & ${evaluationData.teacher} \\\\
    \\hline
    \\textbf{Établissement} & ${evaluationData.school || 'Non spécifié'} \\\\
    \\hline
\\end{tabular}

\\vspace{1cm}
`;
            
            evaluationData.exercises.forEach(exercise => {
                const correction = evaluationData.corrections.find(c => c.exerciseId === exercise.id);
                if (!correction) return;
                
                let exercisePoints = 0;
                exercise.questions.forEach(q => exercisePoints += q.points);
                
                latexCode += `\\section*{Exercice ${romanize(exercise.id + 1)} : ${exercise.title} (${exercisePoints} points)}

${htmlToLatex(exercise.instructions)}

\\begin{enumerate}[label=\\textbf{\\arabic*.}, wide]
`;
                
                exercise.questions.forEach((question, index) => {
                    latexCode += `    \\item[\\hspace{1cm}] ${htmlToLatex(question.text)}
    \\hfill \\textbf{(${question.points} point${question.points > 1 ? 's' : ''})}
    
    \\vspace{0.3cm}
    
    \\noindent\\textbf{Correction:}
    
    ${htmlToLatex(correction.answers[index] || 'Réponse non spécifiée')}
    
    \\vspace{0.5cm}
`;
                });
                
                latexCode += `\\end{enumerate}

\\vspace{0.5cm}
`;
            });
            
            // Ajouter la correction manuelle au LaTeX
            if (evaluationData.manualCorrection) {
                latexCode += `\\section*{Solution complète de l'évaluation}

${htmlToLatex(evaluationData.manualCorrection)}

\\vspace{0.5cm}
`;
            }
            
            latexCode += `\\end{document}`;
            
            document.getElementById('latex-output').textContent = latexCode;
        }
        
        // Fonction pour copier le code LaTeX dans le presse-papier
        function copyLatexToClipboard() {
            const latexOutput = document.getElementById('latex-output');
            const textArea = document.createElement('textarea');
            textArea.value = latexOutput.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Code LaTeX copié dans le presse-papier!');
        }
        
        // Fonctions utilitaires
        function romanize(num) {
            const romanNumerals = [
                '', 'I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X',
                'XI', 'XII', 'XIII', 'XIV', 'XV', 'XVI', 'XVII', 'XVIII', 'XIX', 'XX'
            ];
            
            return romanNumerals[num] || num;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }
        
        function htmlToLatex(html) {
            if (!html) return '';
            
            return html
                .replace(/<strong>(.*?)<\/strong>/g, '\\textbf{$1}')
                .replace(/<b>(.*?)<\/b>/g, '\\textbf{$1}')
                .replace(/<em>(.*?)<\/em>/g, '\\textit{$1}')
                .replace(/<i>(.*?)<\/i>/g, '\\textit{$1}')
                .replace(/<u>(.*?)<\/u>/g, '\\underline{$1}')
                .replace(/<h1>(.*?)<\/h1>/g, '\\section*{$1}')
                .replace(/<h2>(.*?)<\/h2>/g, '\\subsection*{$1}')
                .replace(/<h3>(.*?)<\/h3>/g, '\\subsubsection*{$1}')
                .replace(/<p>(.*?)<\/p>/g, '$1\n\n')
                .replace(/<br\s*\/?>/g, '\\\\')
                .replace(/<ul>(.*?)<\/ul>/gs, '\\begin{itemize}$1\\end{itemize}')
                .replace(/<ol>(.*?)<\/ol>/gs, '\\begin{enumerate}$1\\end{enumerate}')
                .replace(/<li>(.*?)<\/li>/g, '\\item $1')
                .replace(/<sub>(.*?)<\/sub>/g, '\\textsubscript{$1}')
                .replace(/<sup>(.*?)<\/sup>/g, '\\textsuperscript{$1}')
                .replace(/<div class="ql-align-center">(.*?)<\/div>/g, '\\begin{center}$1\\end{center}')
                .replace(/<div class="ql-align-right">(.*?)<\/div>/g, '\\begin{flushright}$1\\end{flushright}')
                .replace(/<[^>]*>/g, '') // Supprimer les balises HTML restantes
                .replace(/&nbsp;/g, ' ')
                .replace(/&amp;/g, '\\&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'")
                .replace(/\n\s*\n/g, '\n\n') // Nettoyer les espaces multiples
                .trim();
        }
    </script>
</body>
</html>
